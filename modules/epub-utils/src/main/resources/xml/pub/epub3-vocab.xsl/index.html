<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html vocab="http://www.daisy.org/ns/pipeline/" typeof="source">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta charset="utf-8">
<meta http-equiv="content-language" content="en">
<link rel="stylesheet" type="text/css" href="/pipeline/css/nxml-mode.css">
<link rel="shortcut icon" href="http://www.daisy.org/sites/default/files/favicon_0.ico">
<link rev="doc" href="../epub3-vocab.xsl">
</head>
<body><div class="code" about="../epub3-vocab.xsl">&lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">stylesheet</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">xsl</span>=<span class="code-xml-attribute-value">"http://www.w3.org/1999/XSL/Transform"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">xs</span>=<span class="code-xml-attribute-value">"http://www.w3.org/2001/XMLSchema"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">pf</span>=<span class="code-xml-attribute-value">"http://www.daisy.org/ns/pipeline/functions"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">f</span>=<span class="code-xml-attribute-value">"http://www.daisy.org/ns/pipeline/internal-functions"</span> <span class="code-xml-attribute-local-name">version</span>=<span class="code-xml-attribute-value">"2.0"</span>&gt;

    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-structure-uri"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'http://idpf.org/epub/vocab/structure/#'"</span>/&gt;
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-structure"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"('acknowledgments',           'etymology',              'index-xref-preferred',    'qna',                            'afterword',                 'example',                'index-xref-related',      'revision-history',                            'antonym-group',             'figure',                 'introduction',            'sense-group',                            'appendix',                  'footnote',               'keyword',                 'sense-list',                            'aside',                     'footnotes',              'landmarks',               'sound-area',                            'assessment',                'foreword',               'learning-objective',      'subtitle',                            'backmatter',                'frontmatter',            'learning-resource',       'synonym-group',                            'balloon',                   'fulltitle',              'list',                    'table',                            'biblioentry',               'glossary',               'list-item',               'table-cell',                            'bibliography',              'glossdef',               'loa',                     'table-row',                            'bodymatter',                'glossterm',              'loi',                     'text-area',                            'chapter',                   'gram-info',              'lot',                     'tip',                            'colophon',                  'halftitle',              'lov',                     'title',                            'concluding-sentence',       'halftitlepage',          'noteref',                 'titlepage',                            'conclusion',                'idiom',                  'notice',                  'toc',                            'condensed-entry',           'imprimatur',             'other-credits',           'topic-sentence',                            'contributors',              'imprint',                'page-list',               'tran',                            'copyright-page',            'index',                  'pagebreak',               'tran-info',                            'cover',                     'index-editor-note',      'panel',                   'volume',                            'covertitle',                'index-entry',            'panel-group',                            'dedication',                'index-entry-list',       'part',                            'def',                       'index-group',            'part-of-speech',                            'dictentry',                 'index-headnotes',        'part-of-speech-group',                            'dictionary',                'index-legend',           'part-of-speech-list',                            'division',                  'index-locator',          'phonetic-transcription',                            'endnote',                   'index-locator-list',     'phrase-group',                            'endnotes',                  'index-locator-range',    'phrase-list',                            'epigraph',                  'index-term',             'preamble',                            'epilogue',                  'index-term-categories',  'preface',                            'errata',                    'index-term-category',    'prologue',                                                        (:draft:)                                                        'abstract',                  'general-problem',        'multiple-choice-problem',                            'answer',                    'glossref',               'ordinal',                            'answers',                   'keywords',               'practice',                            'assessments',               'label',                  'practices',                            'backlink',                  'learning-objectives',    'pullquote',                            'biblioref',                 'learning-outcome',       'question',                            'case-study',                'learning-outcomes',      'seriespage',                            'credit',                    'learning-resources',     'toc-brief',                            'credits',                   'learning-standard',      'true-false-problem',                            'feedback',                  'learning-standards',                            'fill-in-the-blank-problem', 'match-problem',                                                        (:deprecated:)                                                        'annoref',                            'annotation',                            'bridgehead',                            'help',                            'marginalia',                            'note',                            'rearnote',                            'rearnotes',                            'sidebar',                            'subchapter',                            'warning'                            )"</span>/&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-z3998-structure-uri"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'http://www.daisy.org/z3998/2012/vocab/structure/#'"</span>/&gt;
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-z3998-structure"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"('abbreviations',              'email',                      'measure',                   'recipient',                           'acknowledgments',             'email-message',              'mixed',                     'recto',                           'acronym',                     'epigraph',                   'morpheme',                  'reference',                           'actor',                       'epilogue',                   'name-title',                'republisher',                           'afterword',                   'errata',                     'nationality',               'resolving-reference',                           'alteration',                  'essay',                      'non-fiction',               'result',                           'annoref',                     'event',                      'nonresolving-citation',     'role-description',                           'annotation',                  'example',                    'nonresolving-reference',    'roman',                           'appendix',                    'family-name',                'note',                      'root',                           'article',                     'fiction',                    'noteref',                   'salutation',                           'aside',                       'figure',                     'notice',                    'scene',                           'attribution',                 'filmography',                'orderedlist',               'secondary',                           'author',                      'footnote',                   'ordinal',                   'section',                           'award',                       'footnotes',                  'organization',              'sender',                           'backmatter',                  'foreword',                   'other-credits',             'sentence',                           'bcc',                         'fraction',                   'pagebreak',                 'sidebar',                           'bibliography',                'from',                       'page-footer',               'signature',                           'biographical-note',           'frontispiece',               'page-header',               'song',                           'bodymatter',                  'frontmatter',                'part',                      'speech',                           'cardinal',                    'ftp',                        'percentage',                'stage-direction',                           'catalogue',                   'fulltitle',                  'persona',                   'stem',                           'cc',                          'gallery',                    'personal-name',             'structure',                           'chapter',                     'general-editor',             'pgroup',                    'subchapter',                           'citation',                    'geographic',                 'phone',                     'subject',                           'clarification',               'given-name',                 'phoneme',                   'subsection',                           'collection',                  'glossary',                   'photograph',                'subtitle',                           'colophon',                    'grant-acknowledgment',       'phrase',                    'suffix',                           'commentary',                  'grapheme',                   'place',                     'surname',                           'commentator',                 'halftitle',                  'plate',                     'taxonomy',                           'compound',                    'halftitle-page',             'poem',                      'tertiary',                           'concluding-sentence',         'help',                       'portmanteau',               'text',                           'conclusion',                  'homograph',                  'postal',                    'textbook',                           'continuation',                'http',                       'postal-code',               't-form',                           'continuation-of',             'hymn',                       'postscript',                'timeline',                           'contributors',                'illustration',               'practice',                  'title',                           'coordinate',                  'image-placeholder',          'preamble',                  'title-page',                           'correction',                  'imprimatur',                 'preface',                   'to',                           'covertitle',                  'imprint',                    'prefix',                    'toc',                           'currency',                    'index',                      'presentation',              'topic-sentence',                           'decimal',                     'initialism',                 'primary',                   'translator',                           'decorative',                  'introduction',               'product',                   'translator-note',                           'dedication',                  'introductory-note',          'production',                'truncation',                           'diary',                       'ip',                         'prologue',                  'unorderedlist',                           'diary-entry',                 'isbn',                       'promotional-copy',          'valediction',                           'discography',                 'keyword',                    'published-works',           'verse',                           'division',                    'letter',                     'publisher-address',         'verso',                           'drama',                       'loi',                        'publisher-logo',            'v-form',                           'dramatis-personae',           'lot',                        'range',                     'volume',                           'editor',                      'lyrics',                     'ratio',                     'warning',                           'editorial-note',              'marginalia',                 'rearnote',                  'weight',                                                                                        'rearnotes',                 'word'                           )"</span>/&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-package-meta-uri"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'http://idpf.org/epub/vocab/package/meta/#'"</span>/&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-package-link-uri"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'http://idpf.org/epub/vocab/package/link/#'"</span>/&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-package-item-uri"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'http://idpf.org/epub/vocab/package/item/#'"</span>/&gt;
    
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"vocab-package-itemref-uri"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'http://idpf.org/epub/vocab/package/itemref/#'"</span>/&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"f:default-prefixes"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"a11y"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://www.idpf.org/epub/vocab/package/a11y/#"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"dcterms"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://purl.org/dc/terms/"</span>/&gt;
   
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"marc"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://id.loc.gov/vocabulary/"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"media"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://www.idpf.org/epub/vocab/overlays/#"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"onix"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://www.editeur.org/ONIX/book/codelists/current.html#"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"rendition"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://www.idpf.org/vocab/rendition/#"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"schema"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://schema.org/"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"xsd"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"http://www.w3.org/2001/XMLSchema#"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"f:parse-prefix-decl"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"prefix-decl"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string?"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">analyze-string</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$prefix-decl"</span> <span class="code-xml-attribute-local-name">regex</span>=<span class="code-xml-attribute-value">"([^:\s\t\n\r]+):\s*([^\s\t\n\r]+)"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">matching-substring</span>&gt;
                &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"{regex-group(1)}"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"{regex-group(2)}"</span>/&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">matching-substring</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">non-matching-substring</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"not(matches(.,'[\s\t\n\r]+'))"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">message</span> <span class="code-xml-attribute-local-name">terminate</span>=<span class="code-xml-attribute-value">"yes"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"concat('Error parsing prefix attribute: ',$prefix-decl)"</span>/&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">non-matching-substring</span>&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">analyze-string</span>&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span>&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"f:merge-prefix-decl"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"reserved-prefixes"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>/&gt;
        
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$mappings"</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"@uri=($vocab-package-meta-uri,                                           $vocab-package-link-uri,                                           $vocab-package-item-uri,                                           $vocab-package-itemref-uri,                                           $vocab-structure-uri)"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">message</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"concat('Warning: prefix attibute must not be used to define a prefix (',                                                     @prefix, ') that maps to a default vocabulary: ''',                                                     @uri,'''')"</span>/&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
        
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"f:unique-prefixes($mappings)"</span>/&gt;
        
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"some $m in $mappings satisfies                                 $reserved-prefixes[@prefix=$m/@prefix and not(@uri=$m/@uri)]"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$mappings"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"$reserved-prefixes[@prefix=current()/@prefix and not(@uri=current()/@uri)]"</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">message</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"concat('Warning: reserved prefix ',@prefix,' was overridden to ''',@uri,'''')"</span>/&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"f:unique-prefixes(($reserved-prefixes,$mappings))                                           [position()&gt;count($reserved-prefixes)]"</span>/&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$mappings"</span>/&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
        
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"for $p in distinct-values($mappings/@prefix) return $mappings[@prefix=$p][1]"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$mappings"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span>&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"f:unique-prefixes"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"f:unique-prefixes((),$mappings)"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span>&gt;
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"f:unique-prefixes"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"head"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"tail"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"head"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$head"</span>/&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"exists($tail[1])"</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"$head[@prefix=$tail[1]/@prefix and not(@uri=$tail[1]/@uri)]"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"{f:unique-prefix($tail[1]/@prefix,$head/@prefix)}"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"{$tail[1]/@uri}"</span>/&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$tail[1]"</span>/&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"tail"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$tail[position()&gt;1]"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"if (exists($tail[1]))                               then f:unique-prefixes($head, $tail)                               else $head"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span>&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"f:unique-prefix"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"prefix"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"existing"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string*"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"if (not($prefix=$existing))                               then $prefix                               else f:unique-prefix(concat($prefix,'_'),$existing)"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span>&gt;
    
    
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"pf:epub3-vocab-add-prefix"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string?"</span>/&gt; 
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"prefix"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span>/&gt; 
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"uri"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string"</span>/&gt; 
        
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"new-mapping"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)"</span>&gt;
            &lt;<span class="code-xml-element-prefix">f:</span><span class="code-xml-element-local-name">vocab</span> <span class="code-xml-attribute-local-name">prefix</span>=<span class="code-xml-attribute-value">"{$prefix}"</span> <span class="code-xml-attribute-local-name">uri</span>=<span class="code-xml-attribute-value">"{$uri}"</span>/&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"mappings"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(f:vocab)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"f:merge-prefix-decl((                                   if (exists($mappings)) then f:parse-prefix-decl($mappings) else (),                                   $new-mapping),                                 $f:default-prefixes)"</span>/&gt;
        
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"string-join(for $m in $mappings return concat($m/@prefix,': ',$m/@uri),' ')"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">function</span>&gt;
    
&lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">stylesheet</span>&gt;</div></body>
</html>
