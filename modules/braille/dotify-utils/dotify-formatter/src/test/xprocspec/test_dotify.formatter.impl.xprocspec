<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:dotify="http://code.google.com/p/dotify/"
               xmlns:p="http://www.w3.org/ns/xproc"
               xmlns:pxi="http://www.daisy.org/ns/pipeline/xproc/internal"
               pending="true">

  <x:script>
    <p:declare-step type="pxi:test" version="1.0">
      <p:input port="source"/>
      <p:output port="result"/>
      <p:import href="../../main/resources/xml/obfl-normalize-space.xpl"/>
      <p:import href="http://www.daisy.org/pipeline/modules/braille/dotify-utils/library.xpl"/>
      <pxi:obfl-normalize-space/>
      <dotify:obfl-to-pef locale="und" mode="(input:text-css)(output:braille)"/>
    </p:declare-step>
  </x:script>
  <x:scenario label="_" xml:base="http://code.google.com/p/dotify/dotify.formatter.impl/test/org/daisy/dotify/engine/impl/resource-files/dp2/">
  <x:call step="pxi:test"/>
  
  <x:scenario label="page-number">
    <x:documentation>
      Tests simple page-number.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="40" page-height="25">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                <page-number ref-id="x" number-format="default"/>
              </block>
              <block break-before="page" id="x">
                ⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="25" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠼⠃</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="page-number-reference-other-sequence" pending="xfail (Exception)">
    <x:documentation>
      Tests page-number in one sequence referencing a block in another sequence.
      
      Broken: see https://github.com/joeha480/dotify/issues/97.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="40" page-height="25">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                <page-number ref-id="x" number-format="default"/>
              </block>
            </sequence>
            <sequence>
              <block id="x">
                ⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="25" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠼⠃</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="page-number-follows-leader">
    <x:documentation>
      Tests leader followed by page-number.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="10" page-height="25">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block id="chapter_1">⠤</block>
              <block>
                <leader pattern="⠄" position="100%" align="right"/>⠀<page-number ref-id="chapter_1" number-format="default"/>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="25" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤</row>
                  <row>⠄⠄⠄⠄⠄⠄⠄⠀⠼⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="nested-blocks-with-borders">
    <x:documentation>
      Tests nested blocks with borders and margins.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="20" page-height="10" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block margin-left="1"
                     margin-right="1"
                     border-left-style="solid"
                     border-left-align="outer"
                     border-right-style="solid"
                     border-right-align="outer"
                     border-top-style="solid"
                     border-top-align="inner"
                     border-bottom-style="solid"
                     border-bottom-align="inner">
                <block margin-left="2"
                       margin-right="2"
                       margin-top="1"
                       margin-bottom="1"
                       border-left-style="solid"
                       border-left-align="outer"
                       border-right-style="solid"
                       border-right-align="outer"
                       border-top-style="solid"
                       border-top-align="inner"
                       border-bottom-style="solid"
                       border-bottom-align="inner">
                  <block margin-left="1"
                         margin-right="1"
                         margin-top="1"
                         margin-bottom="1"
                         align="center">
                    ⠿⠿⠿⠿
                  </block>
                </block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="10" cols="20" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠀⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠀⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⠀</row>
                  <row>⠀⠇⠀⠀⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠀⠀⠸⠀</row>
                  <row>⠀⠇⠀⠀⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⠀⠀⠸⠀</row>
                  <row>⠀⠇⠀⠀⠇⠀⠀⠀⠿⠿⠿⠿⠀⠀⠀⠸⠀⠀⠸⠀</row>
                  <row>⠀⠇⠀⠀⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⠀⠀⠸⠀</row>
                  <row>⠀⠇⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠀⠀⠸⠀</row>
                  <row>⠀⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⠀</row>
                  <row>⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="border-align-center">
    <x:documentation>
      Tests top and bottom borders with align="center".
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="20" page-height="10" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block border-left-style="solid"
                     border-left-align="outer"
                     border-right-style="solid"
                     border-right-align="outer"
                     border-top-style="solid"
                     border-top-align="center"
                     border-bottom-style="solid"
                     border-bottom-align="center"
                     align="center">
                ⠿⠿⠿⠿
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="20" rows="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠖⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠲</row>
                  <row>⠇⠀⠀⠀⠀⠀⠀⠀⠿⠿⠿⠿⠀⠀⠀⠀⠀⠀⠀⠸</row>
                  <row>⠓⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠚</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="vertical-position-align-before">
    <x:documentation>
      Tests vertical-position and vertical-align="before" on a block with two lines separated by a &lt;br/&gt;.
    </x:documentation>
    <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="20" page-height="10" duplex="false">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block vertical-align="before" vertical-position="5">
              ⠤⠤⠤<br/>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="20" rows="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="vertical-position-align-before-nested-blocks">
    <x:documentation>
      Tests vertical-position and vertical-align="before" on a block with two nested blocks of one line each.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="20" page-height="10" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block vertical-align="before" vertical-position="5">
                <block> ⠤⠤⠤ </block>
                <block> ⠤⠤⠤ </block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="20" rows="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="layout-master-row-spacing">
    <x:documentation>
      Tests row-spacing on layout-master.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="40" page-height="25" row-spacing="2.0">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                ⠤⠤⠤⠤<br/>
                ⠤⠤⠤⠤<br/>
                ⠤⠤⠤⠤<br/>
                ⠤⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="25" rowgap="4" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤</row>
                  <row rowgap="0">⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="block-row-spacing">
    <x:documentation>
      Tests row-spacing on blocks.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="40" page-height="25">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠂⠂⠂⠂⠂<br/>
                <br/>
                ⠯⠗⠼⠜⠌⠄
              </block>
              <block>⠒⠒⠒</block>
              <block row-spacing="2.0">
                ⠤⠤⠤⠤<br/>
                ⠤⠤⠤⠤<br/>
                ⠤⠤⠤⠤<br/>
                ⠤⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="25" rowgap="0" duplex="false">
              <section>
                <page>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠂⠂⠂⠂⠂</row>
                  <row rowgap="4"/>
                  <row rowgap="4">⠯⠗⠼⠜⠌⠄</row>
                  <row>⠒⠒⠒</row>
                  <row rowgap="4">⠤⠤⠤⠤</row>
                  <row rowgap="4">⠤⠤⠤⠤</row>
                  <row rowgap="4">⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="row-spacing-and-margins">
    <x:documentation>
      Tests combinations of row-spacing and (non-collapsed) top/bottom margins, including on nested
      blocks with different row-spacing.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="true" page-width="40" page-height="75">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block margin-top="1" margin-bottom="1" row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁
              </block>
              <block>⠒⠒⠒</block>
              <block margin-top="0" margin-bottom="1" row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁
              </block>
              <block>⠒⠒⠒</block>
              <block margin-top="0" margin-bottom="0" row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁
              </block>
              <block>⠒⠒⠒</block>
              <block margin-top="1" margin-bottom="0" row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁
              </block>
              <block>⠒⠒⠒</block>
              <block margin-top="1" row-spacing="1.0">
                <block margin-top="0" row-spacing="2.0">
                  ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                  ⠁<br/>
                  ⠁<br/>
                  ⠁<br/>
                  ⠁
                </block>
                <block>⠒⠒⠒</block>
                <block margin-top="1" row-spacing="2.0">
                  ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                  ⠁<br/>
                  ⠁<br/>
                  ⠁<br/>
                  ⠁
                </block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="75" rowgap="0" duplex="true">
              <section>
                <page>
                  <row rowgap="4"/>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4"/>
                  <row>⠒⠒⠒</row>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4"/>
                  <row>⠒⠒⠒</row>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row>⠒⠒⠒</row>
                  <row rowgap="4"/>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row>⠒⠒⠒</row>
                  <row rowgap="0"/>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row>⠒⠒⠒</row>
                  <row rowgap="4"/>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row>⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="row-spacing-and-collapsing-margins">
    <x:documentation>
      Tests combinations of row-spacing and collapsing top/bottom margins, including on nested blocks
      with different row-spacing.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="true" page-width="40" page-height="35">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block margin-bottom="1" row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁
              </block>
              <block margin-top="1" margin-bottom="1" row-spacing="2.0">
                ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁<br/>
                ⠁
              </block>
              <block margin-top="1" row-spacing="1.0">
                <block margin-top="0" row-spacing="2.0">
                  ⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁<br/>
                  ⠁<br/>
                  ⠁<br/>
                  ⠁<br/>
                  ⠁
                </block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="35" rowgap="0" duplex="true">
              <section>
                <page>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4"/>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4"/>
                  <row rowgap="4">⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row rowgap="4">⠁</row>
                  <row>⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="header-row-spacing">
    <x:documentation>
      Tests creating empty two-line top page margin using row-spacing on header.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="40" page-height="25" duplex="false" page-number-variable="page">
              <template use-when="(= (% $page 2) 1)">
                <header>
                  <field/>
                </header>
                <footer/>
              </template>
              <template use-when="(= (% $page 2) 0)">
                <header row-spacing="2.0">
                  <field/>
                </header>
                <footer/>
              </template>
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                ⠿
              </block>
              <block break-before="page">
                ⠿
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="25" cols="40" rowgap="0" duplex="false">
              <section>
                <page>
                  <row/>
                  <row>⠿</row>
                </page>
                <page>
                  <row rowgap="4"/>
                  <row>⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="keep-page">
    <x:documentation>
      Tests simple keep="page".
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="10" page-height="6" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              </block>
              <block keep="page">
                ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="keep-with-next">
    <x:documentation>
      Tests simple keep-with-next.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="10" page-height="6" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              </block>
              <block keep="page" keep-with-next="1">
                ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="keep-several-blocks">
    <x:documentation>
      Tests keeping several consecutive blocks together.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="10" page-height="6" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              </block>
              <block>
                <block keep="page" keep-with-next="1">⠤⠤⠤</block>
                <block keep="page" keep-with-next="1">⠤⠤⠤</block>
                <block keep="page" keep-with-next="1">⠤⠤⠤</block>
                <block keep="page">⠤⠤⠤</block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="keep-with-following-sibling-of-parent">
    <x:documentation>
      Tests keeping block with following sibling of parent block.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="10" page-height="6" duplex="false">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              </block>
              <block>
                <block>⠤⠤⠤</block>
                <block keep="page" keep-with-next="1">⠤⠤⠤</block>
              </block>
              <block>⠤⠤⠤⠤⠤</block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="pre-and-post-content">
    <x:documentation>
      Tests single volume with pre-content and post-content.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="10" page-height="25">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <volume-template sheets-in-volume-max="1000">
              <pre-content>
                <sequence master="a">
                  <block>
                    ⠤⠤⠤⠤⠤⠤
                  </block>
                </sequence>
              </pre-content>
              <post-content>
                <sequence master="a">
                  <block>
                    ⠤⠤⠤⠤⠤⠤
                  </block>
                </sequence>
              </post-content>
            </volume-template>
            <sequence master="a">
              <block>
                ⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="25" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="pre-content-use-when">
    <x:documentation>
      Tests two volume-templates with different pre-content.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" duplex="false" page-width="10" page-height="5">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <volume-template use-when="(= $volume 1)" sheets-in-volume-max="3"/>
            <volume-template use-when="(> $volume 1)" sheets-in-volume-max="3">
              <pre-content>
                <sequence master="a">
                  <block>⠿⠿⠿⠿</block>
                </sequence>
              </pre-content>
            </volume-template>
            <sequence master="a">
              <block>
                ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤
                ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤
                ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤
                ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤
                ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤
                ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤ ⠤⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
            <volume cols="10" rows="5" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
            <volume cols="10" rows="5" rowgap="0" duplex="false">
              <section>
                <page>
                  <row>⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠀⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="keep-content-with-border">
    <x:documentation>
      Tests that pages are not broken between a border of a block and the content of that
      block. Tested with keep="page", orphans or widows on the block with the border. Also tested for
      two nested blocks with borders.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="master" duplex="true" page-number-variable="page" page-width="10" page-height="5">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block border-top-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block keep="page" border-top-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2" border-top-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2" border-top-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block border-top-style="solid">
                <block border-top-style="solid">
                  ⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿
                </block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="orphans-widows-counting-and-borders">
    <x:documentation>
      Tests that counting of orphan and widow lines does not include borders.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="master" duplex="true" page-number-variable="page" page-width="10" page-height="5">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2" border-top-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2" border-top-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2" border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2" border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="page-breaking-and-borders">
    <x:documentation>
      Tests borders in combination with page break control. Tests two blocks following each other in
      various situations: with or without keep="page" on the first block, with or without a bottom
      border on the first block, and with keep="page", orphans or widows on the second block.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="master" duplex="true" page-number-variable="page" page-width="10" page-height="6">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block keep="page" border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block keep="page" border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block>
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block keep="page">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
            <sequence master="master">
              <block keep="page" border-bottom-style="solid">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="2">
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="6" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="empty-margin-region">
    <x:documentation>
      Tests empty left margin with margin-region.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="15" page-height="5" duplex="true">
              <default-template>
                <header/>
                <footer/>
                <margin-region align="left" width="2">
                  <indicators/>
                </margin-region>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="15" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="margin-region-and-borders" xfail="true">
    <x:documentation>
      Tests block with border on page with left margin (using margin-region).
      
      Broken: the border extends into the left margin: see
      https://github.com/joeha480/dotify/issues/195.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header/>
                <footer/>
                <margin-region align="left" width="2">
                  <indicators/>
                </margin-region>
              </default-template>
            </layout-master>
            <sequence master="main">
              <block border-top-style="solid" border-top-align="outer">
                ⠿⠿⠿
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="20" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                  <row>⠀⠀⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-indicator">
    <x:documentation>
      Tests margin-region with marker-indicator.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="15" page-height="5" duplex="true">
              <default-template>
                <header/>
                <footer/>
                <margin-region align="left" width="2">
                  <indicators>
                    <marker-indicator markers="indicator/pagenum" indicator="⠿"/>
                  </indicators>
                </margin-region>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                <marker class="indicator/pagenum" value="x"/>
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                <marker class="indicator/pagenum" value="x"/>
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤
                <marker class="indicator/pagenum" value="x"/>
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤
                <marker class="indicator/pagenum" value="x"/>
                ⠤⠤⠤
                <marker class="indicator/pagenum" value="x"/>
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
                <marker class="indicator/pagenum" value="x"/>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="15" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠿⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠿⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠿⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠿⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-indicator-before-block" xfail="true">
    <x:documentation>
      Tests marker-indicator directly followed by a block.
      
      Broken: marker does not create an indicator: see https://github.com/joeha480/dotify/issues/194
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="15" page-height="5" duplex="true">
              <default-template>
                <header/>
                <footer/>
                <margin-region align="left" width="2">
                  <indicators>
                    <marker-indicator markers="foo" indicator="⠿"/>
                  </indicators>
                </margin-region>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                <marker class="foo" value="x"/>
                <block>
                  ⠤⠤⠤
                </block>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="15" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠀⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <!--
      note that generate-dotify-tests.xsl hides the issue at the beginning of a blocks
  -->
  <x:scenario label="white-space-normalization-around-marker">
    <x:documentation>
      Tests white space normalisation near marker elements. Tests that white space at the beginning
      of a block or following a br element is stripped, also when it is preceded directly by a
      marker element. Tests also that white space around a marker element is properly collapsed.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="15" page-height="15" duplex="true">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                ⠤⠤⠤
                ⠤⠤⠤
                ⠤⠤⠤
              </block>
              <block>
                <marker class="foo" value="x"/>
                ⠤⠤⠤
                ⠤⠤⠤
                ⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤
                ⠤⠤⠤
                <br/>
                ⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤
                ⠤⠤⠤
                <br/>
                <marker class="foo" value="x"/>
                ⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤
                ⠤⠤⠤
                ⠤⠤⠤
                ⠤⠤⠤
                <marker class="foo" value="x"/>
                <marker class="foo" value="x"/>
                ⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤
                ⠤⠤⠤
                ⠤⠤⠤
                ⠤⠤⠤<marker class="foo" value="x"/>
                ⠤⠤⠤
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="15" rows="15" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="white-space-normalization-in-span">
    <x:documentation>
      Tests that white space at the beginning and end of a span is not stripped. Dotify would
      normally strip it if DP2 wouldn't inhibit it by adding ZWSP characters. This is done because
      Dotify strips white space too aggressively in some cases. The current solution is not ideal
      either but it is better to strip too little than too much.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="body" page-width="15" page-height="10" duplex="true">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="body">
              <block>
                <span> ⠿⠿ </span> ⠤⠤⠤
              </block>
              <block>
                <span> ⠿⠿ </span><evaluate expression="(round 1)"/>
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="15" rows="10" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠀⠤⠤⠤</row>
                  <row>⠿⠿⠀⠼⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="comment-in-white-space">
    <x:documentation>
      Tests presence of a comment surrounded by white space. Dotify would normally drop the white
      space but pxi:obfl-normalize-space prevents this.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="1" duplex="true" page-number-variable="page">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                ⠁⠁⠁ <!-- comment --> ⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="1" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠁⠁⠁⠀⠁⠁⠁</row> <!-- was: ⠁⠁⠁⠁⠁⠁ -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-sequence-backward">
    <x:documentation>
      Tests marker-reference with scope sequence and direction backward. Tested with markers at the
      beginning of the sequence, in the middle of a page, at a soft page break within a block, at a
      soft page break between two blocks, and at a hard page break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                  <field/>
                  <field/>
                </header>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                <marker class="foo" value="3"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- new page --><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                </page>
                <page>
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 4 -->
                  <row>⠼⠙⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 4 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 5 -->
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 6 -->
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 6 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-page-forward-backward">
    <x:documentation>
      Tests marker-reference with scope page. Tested with both forward and backward
      direction. Tested with markers at the beginning of the sequence, in the middle of a page, at a
      soft page break within a block, at a soft page break between two blocks, and at a hard page
      break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header>
                  <field>
                    <marker-reference marker="foo" direction="forward" scope="page"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="page"/>
                  </field>
                </header>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                <marker class="foo" value="3"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- new page --><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠼⠁</row> <!-- 1   1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <row>⠼⠃⠀⠀⠀⠀⠀⠀⠼⠉</row> <!-- 2   3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 4 -->
                  <row>⠼⠙⠀⠀⠀⠀⠀⠀⠼⠙</row> <!-- 4   4 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 5 -->
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠼⠑</row> <!-- 5   5 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 6 -->
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠼⠋</row> <!-- 6   6 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-page-content-forward-backward">
    <x:documentation>
      Tests marker-reference with scope page-content. Tested with both forward and backward
      direction. Tested with markers at the beginning of the sequence, in the middle of a page, at a
      soft page break within a block, at a soft page break between two blocks, and at a hard page
      break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header>
                  <field>
                    <marker-reference marker="foo" direction="forward" scope="page-content"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="page-content"/>
                  </field>
                </header>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                <marker class="foo" value="3"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- new page --><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page"
                     padding-top="1">
                <block>
                  <marker class="foo" value="7"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <block>
                    <marker class="foo" value="8"/>
                  </block>
                  ⠁⠁⠁⠁⠁
                </block>
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block padding-top="1">
                  <block>
                    <marker class="foo" value="9"/>
                  </block>
                  ⠁⠁⠁⠁⠁
                </block>
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <row>⠼⠃⠀⠀⠀⠀⠀⠀⠼⠉</row> <!-- 2   3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 4 -->
                  <row>⠼⠙⠀⠀⠀⠀⠀⠀⠼⠙</row> <!-- 4   4 --> <!-- should ideally be: (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 5 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 6 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 7 -->
                  <row>⠼⠛⠀⠀⠀⠀⠀⠀⠼⠛</row> <!-- 7   7 -->
                  <row/>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 8 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 9 -->
                  <row>⠼⠊⠀⠀⠀⠀⠀⠀⠼⠊</row> <!-- 9   9 -->
                  <row/>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>

  <x:scenario label="marker-reference-across-sequence-workaround">
    <x:documentation>
      Tests marker-reference with multiple sequences. Currently marker-reference doesn't search
      across sequences. As a workaround I repeat markers at the start of a new sequence when needed.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header/>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo/entry" direction="backward" scope="sequence"/>
                  </field>
                </footer>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
            <sequence master="a">
              <block>
                <marker class="foo/entry" value="1"/>
              </block>
              <block>
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                </page>
              </section>
              <section>
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row> <!-- 1 -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-spread-across-sequence" xfail="true">
    <x:documentation>
      Tests that marker-reference with scope spread searches beyond sequence boundaries, i.e. a
      search on the first page of a new sequence includes assignments made on the last page of the
      previous sequence if that last page is a left-hand page. Also tests that a search on the first
      page of a new sequence does not include assignments made on the last page of the previous
      sequence if that last page is a right-hand page.
      
      The second part of the test is broken. This is possibly another result of the
      https://github.com/joeha480/dotify/issues/134 bug.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <template use-when="(= (% $page 2) 1)">
                <header/>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="forward" scope="spread" start-offset="-1"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="spread"/>
                  </field>
                </footer>
              </template>
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                <!-- right page -->
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- left page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="1"/>
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
            <sequence master="a">
              <block break-before="page">
                <!-- right page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
            <!-- right page -->
            <sequence master="a">
              <block>
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <!-- right -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
                <!-- left -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
              </section>
              <section>
                <!-- right -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠼⠃</row> <!-- 1     2 -->
                </page>
              </section>
              <section>
                <!-- right -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-spread-across-volume">
    <x:documentation>
      Tests that marker-reference with scope spread does not search beyond volume boundaries.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <template use-when="(= (% $page 2) 1)">
                <header/>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="spread"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </template>
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <volume-template sheets-in-volume-max="2"/>
            <sequence master="a">
              <block>
                <!-- right page -->
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- left page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="1"/>
                ⠁⠁⠁⠁⠁
              </block>
              <block break-before="page">
                <!-- right page -->
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- left page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
              </block>
              <block break-before="page">
                <!-- right page -->
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <!-- right -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
                <!-- left -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <!-- right -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                </page>
                <!-- left -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
              </section>
            </volume>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <!-- right -->
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-start-offset-first-page">
    <x:documentation>
      Tests marker-reference with scope page and start-offset -1 on first page of document. Expected
      is that the search does not return anything.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header/>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="forward" scope="page" start-offset="-1"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </default-template>
            </layout-master>
            <sequence master="a">
              <block>
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="1"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
                <page>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-page-first-workaround">
    <x:documentation>
      Tests (hypothetical) marker-reference type that corresponds with 'page-first' in CSS. This
      type is not directly supported in OBFL. As a workaround I do a forward page search (left
      corner in this test), and if that does not return a value, a backward sequence search (right
      corner). Tested with markers at the beginning of the sequence, in the middle of a page, at a
      soft page break within a block, at a soft page break between two blocks, and at a hard page
      break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="5" duplex="true" page-number-variable="page">
              <default-template>
                <header>
                  <field>
                    <marker-reference marker="foo" direction="forward" scope="page"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                </header>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                <marker class="foo" value="3"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- new page --><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠼⠁</row> <!-- 1   1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <row>⠼⠃⠀⠀⠀⠀⠀⠀⠼⠉</row> <!-- 2   3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row> <!--     3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 4 -->
                  <row>⠼⠙⠀⠀⠀⠀⠀⠀⠼⠙</row> <!-- 4   4 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 5 -->
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠼⠑</row> <!-- 5   5 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
                <page>
                  <!-- 6 -->
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠼⠋</row> <!-- 6   6 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-page-start-workaround">
    <x:documentation>
      Tests (hypothetical) marker-reference type that corresponds with 'page-start' in CSS. This
      type is not directly supported in OBFL. As a workaround I do a forward page search for the
      marker 'foo/prev' (rendered top left corner), and if that does not return a value, a backward
      sequence search for the marker 'foo' (top right corner). At any position in the OBFL the value
      of the preceding marker of class 'foo' matches the value of the following marker of class
      'foo/prev'.
      
      In addition, tests marker-reference with scope page and direction backward, which corresponds
      more or less with 'page-last-except-start' in CSS (bottom left corner).
      
      Tested with markers at the beginning of the sequence, in the middle of a page, at a soft page
      break within a block, at a soft page break between two blocks, and at a hard page break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="6" duplex="true" page-number-variable="page">
              <default-template>
                <header>
                  <field>
                    <marker-reference marker="foo/prev" direction="forward" scope="page-content"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                </header>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="page"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="1"/>
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="3"/>
                <marker class="foo" value="3"/>
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- new page --><marker class="foo/prev" value="3"/><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo/prev" value="4"/>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <marker class="foo/prev" value="5"/>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="6" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row> <!--     1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1     -->
                </page>
                <page>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠼⠉</row> <!-- 1   3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row> <!--     3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
                <page>
                  <!-- 4 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠼⠙</row> <!-- 3   4 --> <!-- should ideally be:     4 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠙⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 4     -->
                </page>
                <page>
                  <!-- 5 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠑</row> <!--     5 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5     -->
                </page>
                <page>
                  <!-- 6 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠋</row> <!--     6 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 6     -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-page-start-except-last-workaround">
    <x:documentation>
      Tests (hypothetical) marker-reference type that corresponds with 'page-start-except-last' in
      CSS. This type is not directly supported in OBFL. As a workaround I do a forward page search
      for the marker 'foo/prev' (rendered top left corner). At any position in the OBFL the value of
      the preceding marker of class 'foo' matches the value of the following marker of class
      'foo/prev'.
      
      In addition, tests marker-reference with scope sequence and direction backward, which
      corresponds with 'page-last' in CSS (bottom left corner).
      
      Tested with markers at the beginning of the sequence, in the middle of a page, at a soft page
      break within a block, at a soft page break between two blocks, and at a hard page break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="6" duplex="true" page-number-variable="page">
              <default-template>
                <header>
                  <field>
                    <marker-reference marker="foo/prev" direction="forward" scope="page-content"/>
                  </field>
                  <field/>
                  <field/>
                </header>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo" value="1"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="1"/>
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="3"/>
                <marker class="foo" value="3"/>
                <!-- new page -->
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- new page --><marker class="foo/prev" value="3"/><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block>
                <block>
                  <marker class="foo/prev" value="4"/>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- new page -->
              <block break-before="page">
                <block>
                  <marker class="foo/prev" value="5"/>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="6" rowgap="0" duplex="true">
              <section>
                <page>
                  <!-- 1 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                </page>
                <page>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <page>
                  <!-- 4 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 --> <!-- should ideally be: (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠙⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 4 -->
                </page>
                <page>
                  <!-- 5 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5 -->
                </page>
                <page>
                  <!-- 6 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 6 -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-spread-start-workaround">
    <x:documentation>
      Tests (hypothetical) marker-reference type that corresponds with 'spread-start' in CSS. This
      type is not directly supported in OBFL. As a workaround I do a forward spread search for the
      marker 'foo/prev' starting on the left page (rendered top left corner), and if that does not
      return a value, a backward sequence search for the marker 'foo' starting on the right page
      (top right corner). At any position in the OBFL the value of the preceding marker of class
      'foo' matches the value of the following marker of class 'foo/prev'.
      
      In addition, tests marker-reference with scope spread and direction backward, starting on the
      right page, which corresponds more or less with 'spread-last-except-start' in CSS (bottom left
      corner).
      
      Everything tested on both left- and right-hand pages. Tested with markers at the beginning of
      the sequence, in the middle of a page, at a soft page break within a block, at a soft page
      break between two blocks, and at a hard page break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="6" duplex="true" page-number-variable="page">
              <template use-when="(= (% $page 2) 1)">
                <header>
                  <field>
                    <marker-reference marker="foo/prev" direction="forward" scope="spread-content" start-offset="-1"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                </header>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="spread"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </template>
              <template use-when="(= (% $page 2) 0)">
                <header>
                  <field>
                    <marker-reference marker="foo/prev" direction="forward" scope="spread-content"/>
                  </field>
                  <field/>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence" start-offset="1"/>
                  </field>
                </header>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="spread" start-offset="1"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </template>
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- right page -->
              <block>
                <block>
                  <marker class="foo" value="0"/>
                </block>
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="0"/>
                <marker class="foo" value="1"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- left page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="1"/>
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- right page -->
                <marker class="foo/prev" value="3"/>
                <marker class="foo" value="3"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- left page --><marker class="foo/prev" value="3"/><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- right page -->
              <block>
                <block>
                  <marker class="foo/prev" value="4"/>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- left page -->
              <block break-before="page">
                <block>
                  <marker class="foo/prev" value="5"/>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="6" rowgap="0" duplex="true">
              <section>
                <!-- right -->
                <page>
                  <!-- 0 -->
                  <row>⠼⠚⠀⠀⠀⠀⠀⠀⠼⠁</row> <!-- 0    1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                </page>
                <!-- left -->
                <page>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠼⠉</row> <!-- 1   3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <!-- right -->
                <page>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠼⠉</row> <!-- 1   3 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <!-- left -->
                <page>
                  <!-- 4 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠼⠑</row> <!-- 3   5 --> <!-- should ideally be: 4   5 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5 -->
                </page>
                <!-- right -->
                <page>
                  <!-- 5 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠼⠑</row> <!-- 3   5 --> <!-- should ideally be: 4   5 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5 -->
                </page>
                <!-- left -->
                <page>
                  <!-- 6 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠋</row> <!--     6 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 6 -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="marker-reference-spread-start-except-last-workaround">
    <x:documentation>
      Tests (hypothetical) marker-reference type that corresponds with 'spread-start-except-last' in
      CSS. This type is not directly supported in OBFL. As a workaround I do a forward spread search
      for the marker 'foo/prev' (rendered top left corner). At any position in the OBFL the value of
      the preceding marker of class 'foo' matches the value of the following marker of class
      'foo/prev'.
      
      In addition, tests marker-reference with scope sequence and direction backward, which
      corresponds with 'spread-last' in CSS (bottom left corner).
      
      Everything tested on both left- and right-hand pages. Tested with markers at the beginning of
      the sequence, in the middle of a page, at a soft page break within a block, at a soft page
      break between two blocks, and at a hard page break.
    </x:documentation>
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="a" page-width="10" page-height="6" duplex="true" page-number-variable="page">
              <template use-when="(= (% $page 2) 1)">
                <header>
                  <field>
                    <marker-reference marker="foo/prev" direction="forward" scope="spread-content" start-offset="-1"/>
                  </field>
                  <field/>
                  <field/>
                </header>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </template>
              <template use-when="(= (% $page 2) 0)">
                <header>
                  <field>
                    <marker-reference marker="foo/prev" direction="forward" scope="spread-content"/>
                  </field>
                  <field/>
                  <field/>
                </header>
                <footer>
                  <field>
                    <marker-reference marker="foo" direction="backward" scope="sequence" start-offset="1"/>
                  </field>
                  <field/>
                  <field/>
                </footer>
              </template>
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="a">
              <!-- right page -->
              <block>
                <block>
                  <marker class="foo" value="0"/>
                </block>
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="0"/>
                <marker class="foo" value="1"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- left page -->
                ⠁⠁⠁⠁⠁
                <marker class="foo/prev" value="1"/>
                <marker class="foo" value="2"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <!-- right page -->
                <marker class="foo/prev" value="3"/>
                <marker class="foo" value="3"/>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                <br/><!-- left page --><marker class="foo/prev" value="3"/><marker class="foo" value="4"/>⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- right page -->
              <block>
                <block>
                  <marker class="foo/prev" value="4"/>
                  <marker class="foo" value="5"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
              <!-- left page -->
              <block break-before="page">
                <block>
                  <marker class="foo/prev" value="5"/>
                  <marker class="foo" value="6"/>
                </block>
                ⠁⠁⠁⠁⠁
                ⠁⠁⠁⠁⠁
              </block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="6" rowgap="0" duplex="true">
              <section>
                <!-- right -->
                <page>
                  <!-- 0 -->
                  <row>⠼⠚⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 0 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                </page>
                <!-- left -->
                <page>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 2 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <!-- 3 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <!-- right -->
                <page>
                  <row>⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 1 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 -->
                </page>
                <!-- left -->
                <page>
                  <!-- 4 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 --> <!-- should ideally be: 4 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5 -->
                </page>
                <!-- right -->
                <page>
                  <!-- 5 -->
                  <row>⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 3 --> <!-- should ideally be: 4 -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 5 -->
                </page>
                <!-- left -->
                <page>
                  <!-- 6 -->
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- (empty) -->
                  <row>⠁⠁⠁⠁⠁</row>
                  <row>⠁⠁⠁⠁⠁</row>
                  <row/>
                  <row/>
                  <row>⠼⠋⠀⠀⠀⠀⠀⠀⠀⠀</row> <!-- 6 -->
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
<x:scenario label="various-page-widths">
  <x:documentation>
    Tests two layout-masters with different page-width.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="30" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <layout-master name="b" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="b">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="30" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤</row>
              </page>
            </section>
            <section cols="15">
              <page>
                <row>⠤⠤⠤</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="footer-middle-field-centering" xfail="true">
  <x:documentation>
    Tests position of middle field in footer when left field is empty and right field is
    non-empty.
    
    Broken: The middle field is positioned slightly more towards the left.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value="⠤⠤⠤⠤⠤⠤⠤⠤"/>
                </field>
                <field>
                  <string value="⠿⠿⠿⠿"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠤⠤⠤⠤⠤⠤⠤⠤⠀⠀⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="current-page-various-positions">
  <x:documentation>
    Tests current-page with different layout-masters. Sequences with different layout-masters, that
    each place current-page in a different position (header, footer or nowhere), follow each
    other. Also tests resetting page number with initial-page-number.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="b" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <layout-master name="c" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="b">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="a" initial-page-number="10">
            <block>
              ⠤⠤⠤
            </block>
            <block break-before="page">
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="c">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row> <!-- 1 -->
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠑</row> <!-- 5 -->
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠚</row> <!-- 10 -->
              </page>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠁</row> <!-- 11 -->
              </page>
            </section>
            <section>
              <page>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠃</row> <!-- 12 --> <!-- was: 13 -->
                <row>⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="current-page-various-number-formats" pending="does not work with mode '(input:text-css)(output:braille)'">
  <x:documentation>
    Tests current-page with different number-formats.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="front" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value="⠏"/>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="body" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="rear" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="lower-roman"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="front">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="body">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="rear" initial-page-number="1">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠏⠼⠁</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠊</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="first-line-indent">
  <x:documentation>
    Tests first-line-indent.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="body" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block first-line-indent="2">
              ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                <row>⠤⠤⠤⠀⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="hanging-indentation">
  <x:documentation>
    Tests hanging indentation (text-indent &gt; first-line-indent).
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="body" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              <block first-line-indent="2" text-indent="4">
                ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
              </block>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠀⠀⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
                <row>⠀⠀⠀⠀⠤⠤⠤⠀⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="page-number-backward-reference">
  <x:documentation>
    Tests page-number referencing a previous block.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="body" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              <block>
                ⠿⠿⠿
              </block>
              <block id="x">
                ⠤⠤⠤
              </block>
              <block>
                ⠿⠿⠿
              </block>
              <block id="y">
                ⠤⠤⠤
              </block>
              <block id="z">
                ⠤⠤⠤
              </block>
            </block>
            <block break-before="page">
              <block>
                ⠤⠤⠤
                <page-number ref-id="x" number-format="default"/>
              </block>
              <block>
                ⠤⠤⠤
                <page-number ref-id="y" number-format="default"/>
              </block>
              <block>
                ⠤⠤⠤
                <page-number ref-id="z" number-format="default"/>
              </block>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿</row>
                <row>⠤⠤⠤</row>
                <row>⠿⠿⠿</row>
                <row>⠤⠤⠤</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row>
              </page>
              <page>
                <row>⠤⠤⠤</row>
                <row/>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠃</row>
              </page>
              <page>
                <row>⠤⠤⠤⠀⠼⠁</row>
                <row>⠤⠤⠤⠀⠼⠁</row>
                <row>⠤⠤⠤⠀⠼⠃</row>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="page-number-reference-span" pending="xfail (Exception)">
  <x:documentation>
    Tests page-number reference to span.
    
    Broken: "Failed to complete volume division": is this a bug?
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="body" page-width="14" page-height="8" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              <page-number ref-id="foo" number-format="default"/>
            </block>
            <block>
              ⠤⠤⠤⠤
              <span id="foo">⠿</span>
            </block>
            <block>
              ⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="8" cols="14" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠼⠁</row>
                <row>⠤⠤⠤⠤⠀⠿</row>
                <row>⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="pre-hyphenation">
  <x:documentation>
    Tests (pre-)hyphenation.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="12" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block >
              ⠿⠿⠿⠿⠿⠿ ⠿⠿⠿­⠿⠿⠿ ⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="12" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠤</row>
                <row>⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="collapsing-margins-adjacent-blocks">
  <x:documentation>
    Tests collapsing of margins of adjacent sibling blocks.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="body" page-width="20" page-height="15" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block margin-bottom="1">
              ⠿⠿⠿⠿
            </block>
            <block margin-top="1">
              ⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="15" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿</row>
                <row/>
                <row>⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="collapsing-margins-empty-block">
  <x:documentation>
    Tests collapsing of margins of three adjacent sibling blocks, the middle one being empty.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block margin-bottom="1"> ⠿ </block>
            <block margin-bottom="1"/>
            <block margin-bottom="1"><evaluate expression="&quot;&quot;"/></block>
            <block margin-top="1"> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row/>
                <row>⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="row-spacing-nested-blocks">
  <x:documentation>
    Tests row-spacing on block nested in block with border bottom and default row-spacing.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block border-bottom-style="solid" border-bottom-align="center">
              <block row-spacing="2.0"> ⠿⠿⠿⠿⠿⠿⠿⠿ </block>
            </block>
            <block> ⠿⠿⠿⠿⠿⠿⠿⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="40" rows="25" rowgap="0" duplex="true">
            <section>
              <page>
                <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿</row>
                <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="row-spacing-and-footer" xfail="true">
  <x:documentation>
    Tests row spacing combined with footer.
    
    Broken: the last row of the first page (row 11) does not fit on the page (height 10): see
    https://github.com/joeha480/dotify/issues/196
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="true" page-width="10" page-height="10">
            <default-template>
              <header/>
              <footer>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="main">
            <block row-spacing="2.0">
              ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿
              ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿
              ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿ ⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row/>
                <row>⠼⠁</row>
              </page>
              <page>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row/>
                <row>⠼⠃</row>
              </page>
              <page>
                <row rowgap="4">⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
                <row>⠼⠉</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="single-line-header-empty">
  <x:documentation>
    Tests creating empty single-line top page margin using header.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="multi-line-header-empty">
  <x:documentation>
    Tests creating empty two-line top page margin using multiple headers.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="single-line-header">
  <x:documentation>
    Tests simple single-line header.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value="⠆"/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="multi-line-header-partly-empty">
  <x:documentation>
    Tests creating single-line header within two-line top page margin using multiple headers.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value="⠆"/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="header-vary-height-left-right-pages">
  <x:documentation>
    Tests different height of header on left and right pages.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <template use-when="(= (% $page 2) 1)">
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </template>
            <template use-when="(= (% $page 2) 0)">
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </template>
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
            </block>
            <block break-before="page">
              ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="empty-block">
  <x:documentation>
    Tests empty blocks.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block/>
            <block>⠿</block>
            <block/>
            <block>⠿</block>
            <block> </block>
            <block>⠿ </block>
            <block/>
            <block>⠿</block>
            <block margin-bottom="1"/>
            <block>⠿</block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠀</row>
                <row>⠿</row>
                <row>⠿</row>
                <row/>
                <row>⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="empty-block-border">
  <x:documentation>
    Tests empty blocks with border.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block border-bottom-style="solid" border-bottom-align="outer"/>
            <block border-bottom-style="solid" border-bottom-align="outer"/>
            <block border-bottom-style="solid" border-bottom-align="outer">   </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="25" cols="40" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="single-line-footer-empty">
  <x:documentation>
    Tests creating empty bottom page margin using footer.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row/>
                <row/>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="multi-line-footer-empty">
  <x:documentation>
    Tests creating empty two-line bottom page margin using multiple footers.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="single-line-footer">
  <x:documentation>
    Tests simple single-line footer.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value="⠆"/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row/>
                <row/>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="multi-line-footer-partly-empty">
  <x:documentation>
    Tests creating single-line footer within two-line bottom page margin using multiple footers.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
              <footer>
                <field>
                  <string value="⠆"/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="multi-line-footer">
  <x:documentation>
    Tests multi-line footer.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value="⠆"/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
              <footer>
                <field>
                  <string value="⠆⠆"/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
            <block> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠆⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
              <page>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠿</row>
                <row>⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠆⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="pre-content">
  <x:documentation>
    Tests pre-content.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="1000">
            <pre-content>
              <sequence master="main">
                <block>
                  ⠿⠿⠿
                </block>
              </sequence>
            </pre-content>
          </volume-template>
          <sequence master="main">
            <block>
              ⠤⠤⠤ ⠤⠤⠤ ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤⠀⠤⠤⠤⠀⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="sheets-in-volume-max">
  <x:documentation>
    Tests sheets-in-volume-max.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="10" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="3"/>
          <sequence master="main">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume rows="5" cols="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume rows="5" cols="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="volume-template-various-sheets-in-volume-max">
  <x:documentation>
    Tests two volume-templates (first and rest) with different sheets-in-volume-max.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="10" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template use-when="(! (= $volume 1))" sheets-in-volume-max="3"/>
          <volume-template use-when="(= $volume 1)" sheets-in-volume-max="1"/>
          <sequence master="main">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume rows="5" cols="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume rows="5" cols="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="page-area">
  <x:documentation>
    Tests page-area.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="10" page-height="8" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
            <page-area align="bottom" max-height="5" collection="footnotes">
              <before><leader position="100%" pattern="⠒"/></before>
            </page-area>
          </layout-master>
          <collection name="footnotes">
            <item id="a">
              <block>⠶</block>
            </item>
            <item id="b">
              <block>⠶⠶</block>
            </item>
            <item id="c">
              <block>⠶⠶⠶</block>
            </item>
          </collection>
          <sequence master="main">
            <block>
              ⠿⠿⠿
              <anchor item="a"/>
              ⠿⠿⠿
              <anchor item="b"/>
            </block>
            <block break-before="page">
              ⠿⠿⠿
            </block>
            <block break-before="page">
              ⠿⠿⠿
              <anchor item="c"/>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="8" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠿⠿⠿</row>
                <row/>
                <row/>
                <row/>
                <row/>
                <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                <row>⠶</row>
                <row>⠶⠶</row>
              </page>
              <page>
                <row>⠿⠿⠿</row>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
              </page>
              <page>
                <row>⠿⠿⠿</row>
                <row/>
                <row/>
                <row/>
                <row/>
                <row/>
                <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                <row>⠶⠶⠶</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="list-of-references">
  <x:documentation>
    Tests list-of-references.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="10" page-height="8" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="1000">
            <post-content>
              <dynamic-sequence master="main">
                <list-of-references collection="endnotes" range="volume"/>
              </dynamic-sequence>
            </post-content>
          </volume-template>
          <collection name="endnotes">
            <item id="a">
              <block>
                <page-number ref-id="I" number-format="default"/>
                ⠶
              </block>
            </item>
            <item id="b">
              <block>
                <page-number ref-id="I" number-format="default"/>
                ⠶⠶
              </block>
            </item>
            <item id="c">
              <block>
                <page-number ref-id="III" number-format="default"/>
                ⠶⠶⠶
              </block>
            </item>
          </collection>
          <sequence master="main">
            <block id="I">
              ⠿⠿⠿
              <anchor item="a"/>
              ⠿⠿⠿
              <anchor item="b"/>
            </block>
            <block break-before="page">
              ⠿⠿⠿
            </block>
            <block break-before="page" id="III">
              ⠿⠿⠿
              <anchor item="c"/>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="8" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠼⠁⠀⠶</row>
                <row>⠼⠁⠀⠶⠶</row>
                <row>⠼⠉⠀⠶⠶⠶</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="list-of-references-document-range">
  <x:documentation>
    Tests list-of-references with range="document" and on-volume-start.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="10" page-height="8" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="1000" use-when="(! (= $volume $volumes))"/>
          <volume-template sheets-in-volume-max="1000" use-when="(= $volume $volumes)">
            <post-content>
              <dynamic-sequence master="main">
                <list-of-references collection="endnotes" range="document">
                  <on-volume-start>
                    <block border-bottom-style="solid" border-bottom-align="outer">
                      <evaluate expression="(round $started-volume-number)"/>
                    </block>
                  </on-volume-start>
                </list-of-references>
              </dynamic-sequence>
            </post-content>
          </volume-template>
          <collection name="endnotes">
            <item id="a">
              <block>
                <page-number ref-id="I" number-format="default"/>
                ⠶
              </block>
            </item>
            <item id="b">
              <block>
                <page-number ref-id="I" number-format="default"/>
                ⠶⠶
              </block>
            </item>
            <item id="c">
              <block>
                <page-number ref-id="III" number-format="default"/>
                ⠶⠶⠶
              </block>
            </item>
          </collection>
          <sequence master="main">
            <block id="I">
              ⠿⠿⠿
              <anchor item="a"/>
              ⠿⠿⠿
              <anchor item="b"/>
            </block>
            <block break-before="page">
              ⠿⠿⠿
            </block>
          </sequence>
          <sequence master="main" break-before="volume">
            <block id="III">
              ⠿⠿⠿
              <anchor item="c"/>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="8" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="8" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠼⠁</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠼⠁⠀⠶</row>
                <row>⠼⠁⠀⠶⠶</row>
                <row>⠼⠃</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠼⠉⠀⠶⠶⠶</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="simple-table">
  <x:documentation>
    Tests simple table with no cell wrapping. The table takes up the space it needs to display the
    table data.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table preferred-empty-space="0">
              <tr>
                <td>⠤⠤⠤</td>
                <td>⠿⠿⠿⠿</td>
                <td>⠤⠤⠤</td>
              </tr>
              <tr>
                <td>⠿⠿⠿⠿</td>
                <td>⠤⠤⠤</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠤⠤⠤</td>
                <td>⠿⠿</td>
                <td>⠤⠤⠤</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠀⠿⠿⠿⠿⠤⠤⠤</row>
                <row>⠿⠿⠿⠿⠤⠤⠤⠀⠿⠿⠿</row>
                <row>⠤⠤⠤⠀⠿⠿⠀⠀⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-col-spacing">
  <x:documentation>
    Tests simple table with no cell wrapping. Column spacing is set to 1. The table takes up the
    space it needs to display the table data and column spacing.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1" preferred-empty-space="0">
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠿⠀⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠀⠿⠿⠿⠀⠀⠿⠿⠿</row>
                <row>⠿⠿⠿⠀⠀⠿⠿⠀⠀⠀⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-header-underline">
  <x:documentation>
    Tests simple table with no cell wrapping. Column spacing is set to 1. The table takes up the
    space it needs to display the table data and column spacing. Cells in the first row have a
    bottom border.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1" preferred-empty-space="0">
              <tr>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠿⠀⠿⠿⠿</row>
                <row>⠒⠒⠒⠒⠀⠒⠒⠒⠒⠀⠒⠒⠒</row>
                <row>⠿⠿⠿⠿⠀⠿⠿⠿⠀⠀⠿⠿⠿</row>
                <row>⠿⠿⠿⠀⠀⠿⠿⠀⠀⠀⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-fixed-width">
  <x:documentation>
    Tests simple table with no cell wrapping. Column spacing is set to 1. The column widths are
    computed so that the total table width is equal to the specified width. All cells have similar
    content, therefore all columns are equally wide. Cells in the first row have a bottom border to
    indicate the column widths and spacing.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1" preferred-empty-space="3">
              <tr>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀⠿⠿⠿</row>
                <row>⠒⠒⠒⠒⠒⠒⠀⠒⠒⠒⠒⠒⠒⠀⠒⠒⠒⠒⠒⠒</row>
                <row>⠿⠿⠿⠀⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀⠿⠿⠿</row>
                <row>⠿⠿⠿⠀⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-auto-column-width">
  <x:documentation>
    Tests simple table with no cell wrapping. Column spacing is set to 1. The column widths are
    computed so that the total table width is equal to the specified width and the spacing between
    cell data is optimal. Cells in the first row have a bottom border to indicate the column widths
    and spacing.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1">
              <tr>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿⠿⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀⠀⠿⠿⠿</row>
                <row>⠒⠒⠒⠒⠒⠀⠒⠒⠒⠒⠒⠒⠒⠀⠒⠒⠒⠒⠒</row>
                <row>⠿⠿⠿⠀⠀⠀⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿</row>
                <row>⠿⠿⠿⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀⠀⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-auto-column-width-cell-wrapping" xfail="true">
  <x:documentation>
    Tests table with data that can wrap multiple lines in a cell. The column widths are computed so
    that the total table width is equal to the specified width and the table height is
    minimized. Cells in the first row have a bottom border to indicate the column widths and
    spacing.
    
    Not implemented.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1">
              <tr>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
                <td border-bottom-style="solid" border-bottom-width="1" border-bottom-align="center">⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿⠿⠿⠿ ⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿ ⠿⠿⠿</td>
                <td>⠿⠿⠿ ⠿⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠀⠀⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀</row>
                <row>⠒⠒⠒⠒⠀⠒⠒⠒⠒⠒⠒⠒⠀⠒⠒⠒⠒⠒⠒⠒</row>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠿⠿⠿⠀⠀⠿⠿⠿⠀⠿⠿⠿</row>
                <row>⠀⠀⠀⠀⠀⠿⠿⠿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠀⠀⠀⠀⠀⠿⠿⠿⠀⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-header-repeat" xfail="true">
  <x:documentation>
    Tests repeating of table header rows on each page.
    
    Not implemented.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1">
              <tr>
                <td>⠿⠿⠿⠿⠿</td>
                <td>⠿⠿⠿⠿⠿</td>
                <td>⠿⠿⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀</row>
                <row>⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀</row>
                <row>⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀</row>
                <row>⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀⠀⠿⠿⠀⠀⠀</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-leaders">
  <x:documentation>
    Tests leaders within table cells.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1" preferred-empty-space="0">
              <tr>
                <td>⠿⠿⠿⠿⠿</td>
                <td>⠿⠿⠿⠿⠿</td>
                <td>⠿⠿⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿ <leader pattern="⠄" position="100%" align="right"/></td>
                <td>⠿⠿⠿ <leader pattern="⠄" position="100%" align="right"/></td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿ <leader pattern="⠄" position="100%" align="right"/></td>
                <td>⠿ <leader pattern="⠄" position="100%" align="right"/></td>
                <td>⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠀⠄⠄⠀⠿⠿⠿⠀⠄⠀⠿⠿⠿</row>
                <row>⠿⠀⠄⠄⠄⠀⠿⠀⠄⠄⠄⠀⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-colspan">
  <x:documentation>
    Tests a table cell spanning multiple columns.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1" preferred-empty-space="2">
              <tr>
                <td>⠿⠿⠿⠿</td>
                <td col-span="2">⠿⠿⠿⠿⠿⠿⠿⠿⠿</td>
                <td>⠿⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
                <td>⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿</row>
                <row>⠿⠿⠀⠀⠀⠿⠿⠀⠀⠀⠿⠿⠀⠀⠀⠿⠿</row>
                <row>⠿⠿⠀⠀⠀⠿⠿⠀⠀⠀⠿⠿⠀⠀⠀⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="table-colspan-fill" pending="xfail (Exception)">
  <x:documentation>
    Tests a table cell spanning multiple columns. The cell text is centered and the remaining space
    in the cell filled with a pattern.
    
    Broken: works with a single leader (either the first or the second) but not with both.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" page-width="22" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <table table-col-spacing="1">
              <tr>
                <td>⠿⠿⠿⠿</td>
                <td col-span="4">
                  ⠸<leader pattern="⠒" position="50%" align="center"/>
                  ⠿⠿⠿⠿⠿
                  <leader pattern="⠒" position="100%" align="right"/>⠇
                </td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
              <tr>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
                <td>⠿⠿⠿</td>
              </tr>
            </table>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume rows="5" cols="20" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠀⠸⠒⠒⠒⠀⠿⠿⠿⠿⠿⠀⠒⠒⠒⠇</row>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠀⠿⠿⠿⠀⠿⠿⠿⠀⠿⠿⠿</row>
                <row>⠿⠿⠿⠀⠀⠿⠿⠿⠀⠿⠿⠿⠀⠿⠿⠿⠀⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<!--
<x:scenario label="table-fixed-column-width"/>
<x:scenario label="table-fixed-column-width-cell-wrapping"/>
<x:scenario label="table-cell-borders"/>
<x:scenario label="table-cell-borders-collapsing"/>
<x:scenario label="table-rowspan"/>
<x:scenario label="table-fallback"/>
-->

<x:scenario label="sheets-in-volume">
  <x:documentation>
    Tests variable "sheets-in-volume".
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" duplex="false" page-width="10" page-height="5">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="4">
            <pre-content>
              <sequence master="a">
                <block>
                  <evaluate expression="(round $sheets-in-volume)"/>
                </block>
              </sequence>
            </pre-content>
          </volume-template>
          <sequence master="a">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef version="2008-1" xmlns="http://www.daisy.org/ns/2008/pef">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="5" rowgap="0" duplex="false">
            <section>
              <page>
                <row>⠼⠙</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="false">
            <section>
              <page>
                <row>⠼⠙</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="false">
            <section>
              <page>
                <row>⠼⠉</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="toc-sequence-in-post-content">
  <x:documentation>
    Tests toc-sequence in post-content.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="false" page-width="15" page-height="5">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <table-of-contents name="toc">
            <toc-entry ref-id="ch_1">
              ⠿⠿⠿ ⠄⠄⠄⠄⠄⠄⠄⠄ <page-number ref-id="ch_1" number-format="default"/>
            </toc-entry>
            <toc-entry ref-id="ch_2">
              ⠿⠿⠿ ⠄⠄⠄⠄⠄⠄⠄⠄ <page-number ref-id="ch_2" number-format="default"/>
            </toc-entry>
          </table-of-contents>
          <volume-template sheets-in-volume-max="100">
            <post-content>
              <toc-sequence toc="toc" master="main" range="volume"/>
            </post-content>
          </volume-template>
          <sequence master="main">
            <block id="ch_1" translate=""> ⠿⠿ </block>
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
            <block id="ch_2" translate=""> ⠿⠿ </block>
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef version="2008-1" xmlns="http://www.daisy.org/ns/2008/pef">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="15" rows="5" rowgap="0" duplex="false">
            <section>
              <page>
                <row>⠿⠿</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠿⠿</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤⠀⠤⠤⠤⠤⠤</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠿⠿⠿⠀⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠁</row>
                <row>⠿⠿⠿⠀⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠃</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="block-underline">
  <x:documentation>
    Tests underlining of blocks with various properties and contents.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="false" page-width="15" page-height="50">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <block underline-style="solid">
              ⠌⠌⠌⠌
            </block>
            <block underline-style="solid">
              ⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   padding-left="2">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   margin-left="2">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   align="center">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   padding-right="2"
                   align="center">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   first-line-indent="2">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   text-indent="2"
                   first-line-indent="2">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   text-indent="2"
                   first-line-indent="0">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   row-spacing="2">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   margin-bottom="1">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   padding-bottom="1">
              ⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌ ⠌⠌⠌⠌⠌
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef version="2008-1" xmlns="http://www.daisy.org/ns/2008/pef">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="15" rows="50" rowgap="0" duplex="false">
            <section>
              <page>
                <row>⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤</row>
                <row>⠌⠌⠌⠌⠌</row>
                <row>⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀⠀⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀⠀⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀⠀⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠀⠀⠀⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠀⠀⠌⠌⠌⠌⠌</row>
                <row>⠀⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀⠀⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠀⠀⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠀⠀⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row rowgap="4">⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row rowgap="4">⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row>⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row/>
                <row>⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌⠌</row>
                <row>⠌⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                <row/>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="block-underline-styles">
  <x:documentation>
    Tests various combinations of underline-style, underline-align and underline-width.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="false" page-width="15" page-height="15">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <block underline-style="solid"
                   underline-align="center">
              ⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   underline-align="inner">
              ⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   underline-align="outer">
              ⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   underline-align="inner"
                   underline-width="2">
              ⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   underline-align="outer"
                   underline-width="2">
              ⠌⠌⠌⠌
            </block>
            <block underline-style="solid"
                   underline-width="3">
              ⠌⠌⠌⠌
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef version="2008-1" xmlns="http://www.daisy.org/ns/2008/pef">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="15" rows="15" rowgap="0" duplex="false">
            <section>
              <page>
                <row>⠌⠌⠌⠌</row>
                <row>⠒⠒⠒⠒</row>
                <row>⠌⠌⠌⠌</row>
                <row>⠉⠉⠉⠉</row>
                <row>⠌⠌⠌⠌</row>
                <row>⠤⠤⠤⠤</row>
                <row>⠌⠌⠌⠌</row>
                <row>⠛⠛⠛⠛</row>
                <row>⠌⠌⠌⠌</row>
                <row>⠶⠶⠶⠶</row>
                <row>⠌⠌⠌⠌</row>
                <row>⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="block-underline-with-child-block" pending="undefined behavior">
  <x:documentation>
    Tests underlining of a block with a child block. Currently causes an error because the behavior is undefined.
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="false" page-width="15" page-height="15">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="main">
            <block underline-style="solid">
              ⠌⠌⠌⠌
              <block>
                ⠌⠌⠌⠌
              </block>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
</x:scenario>

<x:scenario label="manual-volume-breaking-toc">
  <x:documentation>
    Tests manual volume breaking in combination with table of contents.
  </x:documentation>
  <x:call step="pxi:test">
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="master" page-width="15" page-height="15">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <table-of-contents name="toc">
            <toc-entry ref-id="a">
              <page-number ref-id="a" number-format="default"/>
            </toc-entry>
            <toc-entry ref-id="b">
              <page-number ref-id="b" number-format="default"/>
            </toc-entry>
          </table-of-contents>
          <volume-template sheets-in-volume-max="10">
            <pre-content>
              <toc-sequence master="master" range="volume" toc="toc"/>
            </pre-content>
          </volume-template>
          <sequence master="master">
            <block id="a">⠿⠿⠿⠿⠿</block>
          </sequence>
          <sequence master="master" break-before="volume">
            <block id="b">⠿⠿⠿⠿⠿</block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="15" rows="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠼⠁</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
          <volume cols="15" rows="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠼⠉</row>
              </page>
            </section>
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="manual-and-automatic-volume-breaking">
  <x:documentation>
    Tests combination of manual and automatic volume breaking.
  </x:documentation>
  <x:call step="pxi:test">
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="true" page-width="10" page-height="5">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="3"/>
          <sequence master="main">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
          <sequence master="main" break-before="volume">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
          <sequence master="main" break-before="volume">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
            <block volume-keep-priority="1">
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
            </block>
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
          <sequence master="main" break-before="volume">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
          <sequence master="main" break-before="volume">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
          <sequence master="main" break-before="volume">
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="volume-breaking-between-blocks">
  <x:documentation>
    Tests volume-transition element, which modifies the last sheet so that volume breaks occur
    between blocks.
  </x:documentation>
  <x:call step="pxi:test">
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="true" page-number-variable="page" page-width="10" page-height="5">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="3"/>
          <volume-transition range="sheet"/>
          <sequence master="main">
            <block>
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
            </block>
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
            <block>
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
            </block>
            <block>
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
              ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤ ⠤⠤⠤⠤⠤
            </block>
            <block>
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
              ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
              <page>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
                <row>⠤⠤⠤⠤⠤</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠿⠿⠿⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="volume-breaking-between-words" xfail="true">
  <x:documentation>
    Tests suppressing of hyphenation of the last line of a volume.
    
    Broken: does not work in combination with a volume-transition element: see
    https://github.com/brailleapps/dotify.formatter.impl/issues/46
  </x:documentation>
  <x:call step="pxi:test">
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="main" duplex="true" page-number-variable="page" page-width="10" page-height="5">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <volume-template sheets-in-volume-max="3"/>
          <volume-transition range="sheet"/>
          <sequence xmlns:css="http://www.daisy.org/ns/pipeline/braille-css" master="main">
            <block>
              ⠁⠁⠁⠁⠁
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿­⠿⠿⠿⠿⠿
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿­⠿⠿⠿⠿⠿
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿­⠿⠿⠿⠿⠿
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿­⠿⠿⠿⠿⠿
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿­⠿⠿⠿⠿⠿
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿­⠿⠿⠿⠿⠿
              ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠁⠁⠁⠁⠁ ⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁⠀⠿⠿⠤</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁⠀⠿⠿⠤</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁⠀⠿⠿⠤</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
              </page>
            </section>
          </volume>
          <volume cols="10" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠿⠿⠿⠿⠿⠿⠿</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁⠀⠿⠿⠤</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁⠀⠿⠿⠤</row>
              </page>
              <page>
                <row>⠿⠿⠿⠿⠿</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁</row>
                <row>⠁⠁⠁⠁⠁⠀⠿⠿</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="break-before-volume-first-sequence" pending="xfail (Exception)">
  <x:documentation>
    Tests break-before="volume" on the first sequence.
    
    If the sequences are of equal size, this (paradoxically) results in the error "Volume sizes too
    uneven: [1, 1]". This seems like a bug in Dotify. This is not a problem, just something we have
    to take into account. We can simply work around it by never putting a break-before="volume" on
    the first sequence.
  </x:documentation>
  <x:call step="pxi:test"/>
  
  <x:scenario label="uneven sequences">
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="master" duplex="true" page-width="10" page-height="5">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="master" break-before="volume">
              <block>⠤⠤⠤⠤⠤</block>
            </sequence>
            <sequence master="master" break-before="volume">
              <block>⠤⠤⠤⠤⠤</block>
              <block break-before="page">⠤⠤⠤⠤⠤</block>
              <block break-before="page">⠤⠤⠤⠤⠤</block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head>
            <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="even sequences" pending="Volume sizes too uneven: [1, 1]">
    <x:call>
      <x:input port="source">
        <x:document type="inline">
          <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
            <layout-master name="master" duplex="true" page-width="10" page-height="5">
              <default-template>
                <header/>
                <footer/>
              </default-template>
            </layout-master>
            <sequence master="master" break-before="volume">
              <block>⠤⠤⠤⠤⠤</block>
            </sequence>
            <sequence master="master" break-before="volume">
              <block>⠤⠤⠤⠤⠤</block>
            </sequence>
          </obfl>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="result">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head>
            <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
            <volume cols="10" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
</x:scenario>

<x:scenario label="br">
  <x:documentation>
    A leading br element is ignored. A trailing br element not.
  </x:documentation>
  <x:call step="pxi:test">
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="master" page-width="15" page-height="15">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="master">
            <block>
              ⠒⠒⠒⠒⠒⠒<br/>
              ⠒⠒⠒⠒⠒⠒
            </block>
            <block>
              ⠒⠒⠒⠒⠒⠒<br/><br/>
              ⠒⠒⠒⠒⠒⠒
            </block>
            <block>
              <br/>⠒⠒⠒⠒⠒⠒
            </block>
            <block>
              ⠒⠒⠒⠒⠒⠒<br/>
            </block>
            <block>
              ⠒⠒⠒⠒⠒⠒
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="15" rows="15" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠒⠒⠒⠒⠒⠒</row>
                <!-- br -->
                <row>⠒⠒⠒⠒⠒⠒</row>
                <!-- block -->
                <row>⠒⠒⠒⠒⠒⠒</row>
                <!-- br -->
                <row/>
                <!-- br -->
                <row>⠒⠒⠒⠒⠒⠒</row>
                <!-- block -->
                <!-- br -->
                <row>⠒⠒⠒⠒⠒⠒</row>
                <!-- block -->
                <row>⠒⠒⠒⠒⠒⠒</row>
                <!-- br -->
                <row/>
                <!-- block -->
                <row>⠒⠒⠒⠒⠒⠒</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>


<x:scenario label="margin-region-and-border">
  <x:documentation>
    Tests combination of a left aligned margin-region and a border.
  </x:documentation>
  <x:call step="pxi:test">
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="master" duplex="true" page-width="19" page-height="5">
            <default-template>
              <header/>
              <footer/>
              <margin-region align="left" width="2">
                <indicators/>
              </margin-region>
            </default-template>
          </layout-master>
          <sequence master="master">
            <block border-left-style="solid"
                   border-left-align="outer"
                   border-right-style="solid"
                   border-right-align="outer"
                   border-top-style="solid"
                   border-top-align="outer"
                   border-bottom-style="solid"
                   border-bottom-align="outer"
                   align="center">
              ⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head>
          <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="19" rows="5" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠀⠀⠏⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠹</row>
                <row>⠀⠀⠇⠀⠀⠀⠀⠀⠿⠿⠿⠿⠿⠀⠀⠀⠀⠀⠸</row>
                <row>⠀⠀⠧⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠼</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

<x:scenario label="break-before-sheet">
  <x:documentation>
    Tests break-before="sheet".
  </x:documentation>
  <x:call>
    <x:input port="source">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false">
          <layout-master name="a" duplex="true" page-width="10" page-height="10">
            <default-template>
              <header>
                <field>
                  <string value="⠇"/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠛⠛⠛
            </block>
            <block break-before="sheet">
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:input>
  </x:call>
  <x:context label="result">
    <x:document type="port" port="result"/>
  </x:context>
  <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
    <x:document type="inline">
      <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
        <head xmlns:dc="http://purl.org/dc/elements/1.1/">
          <meta>
            <dc:format>application/x-pef+xml</dc:format>
          </meta>
        </head>
        <body>
          <volume cols="10" rows="10" rowgap="0" duplex="true">
            <section>
              <page>
                <row>⠇</row>
                <row>⠛⠛⠛</row>
              </page>
              <page>
                <row>⠇</row>
              </page>
              <page>
                <row>⠇</row>
                <row>⠤⠤⠤</row>
              </page>
            </section>
          </volume>
        </body>
      </pef>
    </x:document>
  </x:expect>
</x:scenario>

</x:scenario>
</x:description>
