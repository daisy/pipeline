<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html vocab="http://www.daisy.org/ns/pipeline/" typeof="source">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta charset="utf-8">
<meta http-equiv="content-language" content="en">
<link rel="stylesheet" type="text/css" href="/pipeline/css/nxml-mode.css">
<link rel="shortcut icon" href="http://www.daisy.org/sites/default/files/favicon_0.ico">
<link rev="doc" href="../fileset-compose.xsl">
</head>
<body><div class="code" about="../fileset-compose.xsl">&lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">stylesheet</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">xsl</span>=<span class="code-xml-attribute-value">"http://www.w3.org/1999/XSL/Transform"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">xs</span>=<span class="code-xml-attribute-value">"http://www.w3.org/2001/XMLSchema"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">pf</span>=<span class="code-xml-attribute-value">"http://www.daisy.org/ns/pipeline/functions"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">d</span>=<span class="code-xml-attribute-value">"http://www.daisy.org/ns/pipeline/data"</span> <span class="code-xml-attribute-prefix">xmlns:</span><span class="code-xml-attribute-local-name">map</span>=<span class="code-xml-attribute-value">"http://www.w3.org/2005/xpath-functions/map"</span> <span class="code-xml-attribute-local-name">version</span>=<span class="code-xml-attribute-value">"3.0"</span> <span class="code-xml-attribute-local-name">exclude-result-prefixes</span>=<span class="code-xml-attribute-value">"#all"</span>&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">import</span> <span class="code-xml-attribute-local-name">href</span>=<span class="code-xml-attribute-value">"<a href="/pipeline/modules/common-utils/src/main/resources/xml/xslt/library.xsl" class="source">http://www.daisy.org/pipeline/modules/common-utils/library.xsl</a>"</span>/&gt;
    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">import</span> <span class="code-xml-attribute-local-name">href</span>=<span class="code-xml-attribute-value">"<a href="/pipeline/modules/file-utils/src/main/resources/xml/xslt/library.xsl" class="source">http://www.daisy.org/pipeline/modules/file-utils/library.xsl</a>"</span>/&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"limit-scope"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:boolean"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"false()"</span>/&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span> <span class="code-xml-attribute-local-name">match</span>=<span class="code-xml-attribute-value">"/d:fileset"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(d:fileset)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(d:fileset)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"collection()[2]/*"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"base"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"xs:string?"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"($b,$a)[@xml:base][1]/pf:normalize-uri(base-uri(.))"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">copy</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"exists($base)"</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">attribute</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"xml:base"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$base"</span>/&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"@* except @xml:base"</span>/&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"files-and-anchors"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a"</span>/&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b"</span>/&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a-files"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a[not(map:contains(.,'id'))]"</span>/&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a-anchors"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a[map:contains(.,'id')]"</span>/&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-files"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b[not(map:contains(.,'id'))]"</span>/&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-anchors"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b[map:contains(.,'id')]"</span>/&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-files"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-files[.('original-href')=$a-file('href')]"</span>/&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"exists($b-file)"</span>&gt;
                            
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-file"</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-file('href')"</span>/&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-file('original-href')"</span>/&gt;
                                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-file"</span>/&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchors"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a-anchor"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-anchor"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchors[.('original-id')=$a-anchor('id') and                                                      .('original-href')=$a-anchor('href')]"</span>/&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"exists($b-anchor)"</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"count($b-anchor) &gt; 1"</span>&gt;
                                
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">call-template</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"pf:warn"</span>&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">with-param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"msg"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"'Ambiguous mapping for anchor.'"</span>/&gt;
                                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">call-template</span>&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-anchor"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor[1]"</span>/&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor('href')"</span>/&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor('id')"</span>/&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchor('original-href')"</span>/&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchor('original-id')"</span>/&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-files[.('original-href')=$a-anchor('href')]"</span>/&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"exists($b-file)"</span>&gt;
                                    
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-file[1]"</span>/&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-file('href')"</span>/&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchor('id')"</span>/&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchor('original-href')"</span>/&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchor('original-id')"</span>/&gt;
                                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-anchor"</span>/&gt;
                                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"not($limit-scope)"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-files"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"some $a-file in $a-files                                             satisfies $a-file('href')=$b-file('original-href')"</span>&gt;
                                
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                                
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-file"</span>/&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchors"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"b-anchor"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"some $a-anchor in $a-anchors                                             satisfies $a-anchor('href')=$b-anchor('original-href') and                                                       $a-anchor('id')=$b-anchor('original-id')"</span>&gt;
                                
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                                
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-files[.('href')=$b-anchor('original-href')]"</span>/&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"exists($a-file)"</span>&gt;
                                        
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"a-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-file[1]"</span>/&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor('href')"</span>/&gt;
                                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor('id')"</span>/&gt;
                                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$a-file('original-href')"</span>/&gt;
                                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor('original-id')"</span>/&gt;
                                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$b-anchor"</span>/&gt;
                                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"files-and-anchors"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element()*"</span>&gt; 
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$files-and-anchors"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"attributes"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"attribute()*"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"map"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)*"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"."</span>/&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"map:keys($map)"</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">attribute</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"{.}"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$map(.)"</span>/&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"$attributes[name()='id']"</span>&gt;
                            &lt;<span class="code-xml-element-prefix">d:</span><span class="code-xml-element-local-name">anchor</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$attributes"</span>/&gt;
                            &lt;/<span class="code-xml-element-prefix">d:</span><span class="code-xml-element-local-name">anchor</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">when</span>&gt;
                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                            &lt;<span class="code-xml-element-prefix">d:</span><span class="code-xml-element-local-name">file</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$attributes"</span>/&gt;
                            &lt;/<span class="code-xml-element-prefix">d:</span><span class="code-xml-element-local-name">file</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">otherwise</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">choose</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"files-with-anchors"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"element(d:file)*"</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each-group</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$files-and-anchors"</span> <span class="code-xml-attribute-local-name">group-by</span>=<span class="code-xml-attribute-value">"@original-href"</span>&gt;
                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each-group</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"current-group()"</span> <span class="code-xml-attribute-local-name">group-by</span>=<span class="code-xml-attribute-value">"@href"</span>&gt;
                        &lt;<span class="code-xml-element-prefix">d:</span><span class="code-xml-element-local-name">file</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">attribute</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"href"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"if (exists($base))                                                                then pf:relativize-uri(@href,$base)                                                                else @href"</span>/&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"not(@original-href=@href)"</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"@original-href"</span>/&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
                            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"current-group()[self::d:anchor]"</span>&gt;
                                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">copy</span>&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"@id"</span>/&gt;
                                    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span> <span class="code-xml-attribute-local-name">test</span>=<span class="code-xml-attribute-value">"not(@original-id=@id)"</span>&gt;
                                        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"@original-id"</span>/&gt;
                                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">if</span>&gt;
                                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">copy</span>&gt;
                            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each</span>&gt;
                        &lt;/<span class="code-xml-element-prefix">d:</span><span class="code-xml-element-local-name">file</span>&gt;
                    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each-group</span>&gt;
                &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">for-each-group</span>&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$files-with-anchors"</span>/&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">copy</span>&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span>&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">match</span>=<span class="code-xml-attribute-value">"/d:fileset"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"#current"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"*"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">with-param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"base"</span> <span class="code-xml-attribute-local-name">tunnel</span>=<span class="code-xml-attribute-value">"yes"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"base-uri(.)"</span>/&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span>&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span>&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">match</span>=<span class="code-xml-attribute-value">"/d:fileset/d:file[@href]"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"normalized-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
                &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"#current"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"@*"</span>/&gt;
            &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">variable</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"normalized-file"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"if (@original-href)                               then $normalized-file                               else map:put($normalized-file,'original-href',$normalized-file('href'))"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">sequence</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$normalized-file"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"#current"</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">with-param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"normalized-parent"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$normalized-file"</span>/&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">apply-templates</span>&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span>&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">match</span>=<span class="code-xml-attribute-value">"d:file/@href|                          d:file/@original-href"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"base"</span> <span class="code-xml-attribute-local-name">tunnel</span>=<span class="code-xml-attribute-value">"yes"</span> <span class="code-xml-attribute-local-name">required</span>=<span class="code-xml-attribute-value">"yes"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"name()"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"pf:normalize-uri(resolve-uri(.,$base))"</span>/&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span>&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">match</span>=<span class="code-xml-attribute-value">"/d:fileset/d:file/d:anchor[@id]"</span>&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">param</span> <span class="code-xml-attribute-local-name">name</span>=<span class="code-xml-attribute-value">"normalized-parent"</span> <span class="code-xml-attribute-local-name">as</span>=<span class="code-xml-attribute-value">"map(*)"</span> <span class="code-xml-attribute-local-name">required</span>=<span class="code-xml-attribute-value">"yes"</span>/&gt;
        &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$normalized-parent('href')"</span>/&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-href'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"$normalized-parent('original-href')"</span>/&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"string(@id)"</span>/&gt;
            &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map-entry</span> <span class="code-xml-attribute-local-name">key</span>=<span class="code-xml-attribute-value">"'original-id'"</span> <span class="code-xml-attribute-local-name">select</span>=<span class="code-xml-attribute-value">"if (@original-id)                                                        then string(@original-id)                                                        else string(@id)"</span>/&gt;
        &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">map</span>&gt;
    &lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span>&gt;

    &lt;<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">template</span> <span class="code-xml-attribute-local-name">mode</span>=<span class="code-xml-attribute-value">"parse"</span> <span class="code-xml-attribute-local-name">match</span>=<span class="code-xml-attribute-value">"@*|node()"</span> <span class="code-xml-attribute-local-name">priority</span>=<span class="code-xml-attribute-value">"0.4"</span>/&gt;

&lt;/<span class="code-xml-element-prefix">xsl:</span><span class="code-xml-element-local-name">stylesheet</span>&gt;</div></body>
</html>
